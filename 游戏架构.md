# 阴阳劫游戏项目架构文档

## 项目概述
这是一个基于HTML5 Canvas的2D平台跳跃游戏，主题为"阴阳劫"，玩家可以在阴阳两种环境中切换，体验不同的游戏机制。项目采用模块化架构设计，实现了完整的游戏系统，包括用户认证、关卡管理、成就系统、存档管理等核心功能。

## 架构设计原则
1. **模块化设计**：将游戏功能拆分为独立的管理器模块，降低耦合度
2. **职责分离**：每个管理器负责特定功能领域，便于维护和扩展
3. **事件驱动**：通过事件系统实现模块间的松耦合通信
4. **状态管理**：使用状态机模式管理游戏状态转换
5. **资源管理**：统一的资源加载和缓存机制

## 项目根目录结构
```
D:\github游戏\
├── index.html                    # 主入口页面（登录/注册界面）
├── 代码备忘录.md                 # 项目代码说明文档
├── 关卡管理说明.md               # 关卡管理相关说明
├── src/                         # 源代码目录
│   └── auth/                    # 认证模块
│       └── auth.js              # 用户认证逻辑
├── styles/                      # 样式文件目录
│   └── style.css                # 主样式文件
├── video/                       # 视频资源目录
└── work/                        # 游戏核心工作目录
    ├── about-us/                # 关于我们页面
    ├── bgms/                    # 背景音乐资源
    ├── images/                  # 游戏图片资源
    ├── js/                      # JavaScript游戏逻辑
    ├── map/                     # 地图配置文件
    └── sound/                   # 音效资源
```

## 详细目录结构

### 1. 主入口文件
- **index.html**: 游戏主入口，包含登录/注册界面和主菜单
- **styles/style.css**: 主界面样式文件

### 2. 认证系统 (src/auth/)
- **auth.js**: 用户登录、注册、密码验证等认证功能

### 3. 游戏核心模块 (work/)

#### 3.1 关于我们页面 (about-us/)
```
about-us/
├── index.html           # 团队成员展示主页
├── style.css           # 团队成员页面样式
├── member-style.css    # 成员详情页样式
├── script.js           # 页面交互脚本
├── member1.html        # 成员1详情页
├── member2.html        # 成员2详情页
├── member3.html        # 成员3详情页
├── member4.html        # 成员4详情页
├── member5.html        # 成员5详情页
├── member6.html        # 成员6详情页
└── images/             # 成员头像图片
    ├── member1.jpg
    ├── member2.jpg
    ├── member3.jpg
    ├── member4.jpg
    ├── member5.jpg
    └── member6.jpg
```

#### 3.2 音频资源 (bgms/ & sound/)
```
bgms/                   # 背景音乐
├── bg1.mp3
├── boss2.mp3
├── jiaoxue.mp3
└── guanqia.mp3

sound/                  # 游戏音效
├── change.mp3          # 环境切换音效
├── death.mp3           # 死亡音效
├── enemydeath.mp3      # 敌人死亡音效
├── explode.wav         # 爆炸音效
├── fallog.mp3          # 掉落音效
├── five_beeps.MP3      # 提示音效
├── jump.mp3            # 跳跃音效
├── move.mp3            # 移动音效
├── typing.mp3          # 打字音效
└── wood_snap.wav       # 木头断裂音效
```

#### 3.3 图片资源 (images/)
```
images/
├── 游戏角色与敌人/
│   ├── player.png          # 玩家角色
│   ├── enemy-black.png     # 黑色敌人
│   ├── enemy-white.png     # 白色敌人
│   ├── enemy2.png          # 敌人类型2
│   ├── enemy21.png         # 敌人类型2变体1
│   ├── enemy22.png         # 敌人类型2变体2
│   ├── boss.png            # Boss角色
│   ├── boss2.png           # Boss角色变体
│   ├── boss-dash.png       # Boss冲刺状态
│   └── boss-dash2.png      # Boss冲刺状态变体
├── 游戏道具与机关/
│   ├── bagua.png           # 八卦图
│   ├── baguazhen.png       # 八卦阵
│   ├── taiji.png           # 太极图
│   ├── trampoline_black.png # 黑色蹦床
│   ├── trampoline_white.png # 白色蹦床
│   ├── portal.png          # 传送门
│   ├── point.png           # 得分点
│   └── vine1-5.png         # 藤蔓1-5
├── 地图与背景/
│   ├── map1.png            # 地图1
│   ├── tile.png            # 地图瓦片
│   ├── start1-3.jpg        # 开始界面背景1-3
│   ├── jiaoxuebg.jpg       # 教学关背景
│   └── lib2.png            # 图书馆背景
├── 特效与粒子/
│   ├── fratile1-5.png      # 碎片特效1-5
│   ├── Explosion.js        # 爆炸特效
│   └── LavaParticle.js     # 熔岩粒子特效
├── UI界面元素/
│   ├── diagbg1-4.png       # 对话框背景1-4
│   ├── die.png             # 死亡界面
│   ├── hitbox.png          # 碰撞箱显示
│   └── hurt_box.png        # 伤害判定框
├── 教学关卡/
│   ├── jiaoxue1.png        # 教学关图片1
│   └── jiaoxue2.png        # 教学关图片2
└── cg插图/                 # 剧情插图
    ├── 主线背景.jpg
    ├── 开场/
    │   ├── 宗门.jpg
    │   ├── 打斗.jpg
    │   └── 结束.jpg
    ├── 教学关背景.jpg
    ├── 过场/
    │   ├── 古塔.jpg
    │   └── 赶路.jpg
    └── 结局/
```

#### 3.4 地图配置 (map/)
```
map/
├── begin.json           # 开始关卡
├── test_1.json          # 测试关卡1
├── test_2.json          # 测试关卡2
├── jiaoxue1.json        # 教学关卡1
├── jiaoxue2.json        # 教学关卡2
├── bg-map1.json         # 背景地图1
├── bg-map2.json         # 背景地图2
├── bg-map3.json         # 背景地图3
├── bg-map4.json         # 背景地图4
├── bg4.json             # 背景4
├── bgtest.json          # 背景测试
└── zhengshi_2.json      # 正式关卡2
```

#### 3.5 JavaScript游戏逻辑 (js/)
```
js/
├── 核心游戏文件/
│   ├── game.js              # 游戏主类，核心逻辑控制器
│   ├── game.html            # 游戏页面
│   ├── game-style.css       # 游戏界面样式
│   └── game-ui.js           # 游戏UI管理
├── 关卡管理/
│   ├── level-select.html    # 关卡选择页面
│   ├── level-select.js      # 关卡选择逻辑
│   ├── level-select-style.css # 关卡选择样式
│   └── init-config.js       # 关卡配置初始化
├── 管理器模块/
│   ├── datamanager.js       # 数据管理器（JSON、图片加载）
│   ├── mapmanager.js        # 地图管理器
│   ├── entitymanager.js     # 实体管理器（玩家、敌人等）
│   ├── inputmanager.js      # 输入管理器（键盘控制）
│   ├── eventmanager.js      # 事件管理器
│   ├── soundmanager.js      # 音效管理器
│   ├── bgmmanager.js        # 背景音乐管理器
│   ├── savemanager.js       # 存档管理器
│   ├── cgmanager.js         # CG剧情管理器
│   ├── nightmanager.js      # 夜晚模式管理器
│   ├── TaijiManager.js      # 太极管理器
│   ├── AnimationManager.js  # 动画管理器
│   ├── OverManager.js       # 游戏结束管理器
│   ├── bagua.js             # 八卦管理器
│   └── achievements.js      # 成就管理器
├── 游戏对象/
│   ├── Sprite.js            # 精灵基类
│   ├── Boss.js              # Boss类
│   ├── diveBoss.js          # 潜水Boss类
│   ├── enemy.js             # 敌人类
│   ├── enemy2.js            # 敌人类型2
│   ├── Fratile.js           # 碎片类
│   ├── Trampoline.js        # 蹦床类
│   ├── Movetile.js          # 移动平台类
│   ├── Explosion.js         # 爆炸特效类
│   └── LavaParticle.js      # 熔岩粒子特效类
├── 游戏系统/
│   ├── hp.js                # 血量系统
│   ├── dialog.js            # 对话框系统
│   ├── draw.js              # 绘制系统（DrawManager）
│   ├── bossdraw.js          # Boss绘制管理器
│   └── Util.js              # 工具类
├── 测试文件/
│   ├── hp-test.html         # 血量系统测试
│   ├── tr.html              # 测试页面
│   ├── dialog-test-standalone.html # 对话框测试
│   └── test-narration-dialog.js    # 旁白对话框测试
├── 样式文件/
│   ├── dialog-style.css     # 对话框样式
│   └── game-style.css       # 游戏样式
├── 数据文件/
│   ├── yang-right-0.json    # 阳环境精灵数据
│   └── ying-data.json       # 阴环境精灵数据
└── 文档/
    └── REFACTOR_SUMMARY.md  # 重构总结文档
```

## 游戏核心架构

### 架构层次图
```
┌─────────────────────────────────────────────────────────────┐
│                    游戏主控制器 (game.js)                    │
├─────────────────────────────────────────────────────────────┤
│  状态管理  │  关卡管理  │  用户管理  │  系统协调  │  生命周期  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      管理器层 (Managers)                    │
├─────────────────────────────────────────────────────────────┤
│ 数据管理 │ 地图管理 │ 实体管理 │ 输入管理 │ 事件管理 │ 音频管理 │
│ 存档管理 │ 动画管理 │ 太极管理 │ 成就管理 │ CG管理  │ 夜晚管理 │
│ 绘制管理 │ Boss管理 │ 八卦管理 │ 结束管理 │ 音效管理 │ BGM管理  │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      游戏对象层 (Game Objects)               │
├─────────────────────────────────────────────────────────────┤
│ 玩家 │ 敌人 │ Boss │ 道具 │ 特效 │ 粒子 │ 精灵 │ 瓦片 │ 碰撞体 │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│                      工具层 (Utilities)                     │
├─────────────────────────────────────────────────────────────┤
│ 矩形碰撞 │ 动画系统 │ 资源加载 │ 事件系统 │ 状态机 │ 工具函数 │
└─────────────────────────────────────────────────────────────┘
```

### 核心管理器详细说明

#### 1. 游戏主控制器 (game.js)
- **职责**: 游戏生命周期管理、管理器协调、状态控制
- **核心功能**:
  - 游戏初始化 (`init()`)
  - 游戏循环 (`update()`)
  - 状态管理 (running/paused/over)
  - 关卡解锁系统
  - 暂停/恢复/重启功能

#### 2. 数据管理器 (datamanager.js)
- **职责**: 资源加载和管理
- **核心功能**:
  - JSON配置加载 (JSONP方式)
  - 图片资源加载
  - 精灵表加载
  - 资源缓存管理

#### 3. 地图管理器 (mapmanager.js)
- **职责**: 地图系统核心
- **核心功能**:
  - 地图加载和解析
  - 碰撞检测系统
  - 瓦片渲染管理
  - 环境切换处理
  - 攻击判定系统

#### 4. 实体管理器 (entitymanager.js)
- **职责**: 玩家控制核心
- **核心功能**:
  - 玩家移动控制
  - 物理引擎 (重力、摩擦、跳跃)
  - 动画状态管理
  - 碰撞检测
  - 音效触发

#### 5. 输入管理器 (inputmanager.js)
- **职责**: 用户输入处理
- **核心功能**:
  - 键盘事件监听
  - 输入状态管理
  - 按键映射
  - 输入验证

#### 6. 事件管理器 (eventmanager.js)
- **职责**: 游戏事件系统
- **核心功能**:
  - 事件队列管理
  - 事件分发
  - 传送门处理
  - 关卡切换

#### 7. 音频管理系统
- **音效管理器 (soundmanager.js)**:
  - 音效加载和播放
  - 循环音效管理
  - 音量控制
  - 音效淡入淡出
- **背景音乐管理器 (bgmmanager.js)**:
  - BGM加载和播放
  - 音乐切换
  - 音量设置保存

#### 8. 存档管理器 (savemanager.js)
- **职责**: 数据持久化
- **核心功能**:
  - 游戏进度保存
  - 设置数据保存
  - 用户数据隔离
  - 版本兼容处理

#### 9. 特殊效果管理器
- **太极管理器 (TaijiManager.js)**:
  - 阴阳切换动画
  - 太极图特效
  - 切换音效
- **夜晚管理器 (nightmanager.js)**:
  - 夜晚模式控制
  - 聚光灯效果
  - 光照系统

#### 10. 游戏系统管理器
- **成就管理器 (achievements.js)**:
  - 成就检测和解锁
  - 成就提示系统
  - 成就数据保存
- **八卦管理器 (bagua.js)**:
  - 八卦图系统
  - 特殊机制处理
- **CG管理器 (cgmanager.js)**:
  - 剧情动画播放
  - CG资源管理

#### 11. 绘制系统
- **绘制管理器 (draw.js)**:
  - 地图元素绘制
  - 背景渲染
  - 特效绘制
- **Boss绘制管理器 (bossdraw.js)**:
  - Boss专属绘制
  - Boss动画效果

#### 12. 游戏对象系统
- **基础类**:
  - `Sprite`: 精灵基类
  - `Rect`: 矩形碰撞类
  - `Util`: 工具函数集合
- **游戏实体**:
  - `Boss`: Boss类
  - `Enemy`: 敌人类
  - `Fratile`: 易碎块类
  - `Trampoline`: 蹦床类
  - `Explosion`: 爆炸特效类

### 数据流架构

#### 1. 初始化流程
```
game.init() → 创建管理器 → 加载资源 → 初始化系统 → 开始游戏循环
```

#### 2. 游戏循环
```
输入检测 → 状态更新 → 碰撞检测 → 渲染绘制 → 音效播放
```

#### 3. 环境切换流程
```
用户输入 → TaijiManager触发 → 物理参数调整 → 视觉效果切换 → 音效播放
```

### 游戏特色系统

#### 1. 阴阳切换机制
- **技术实现**: 通过环境状态管理，动态调整物理参数
- **视觉效果**: 太极图动画和背景切换
- **音效反馈**: 切换音效和环境音变化

#### 2. 模块化管理器架构
- **设计模式**: 管理器模式，职责分离
- **通信机制**: 通过游戏主类进行协调
- **扩展性**: 新功能通过添加新管理器实现

#### 3. 响应式渲染系统
- **Canvas渲染**: 基于HTML5 Canvas的2D渲染
- **动画系统**: 帧动画和补间动画结合
- **特效系统**: 粒子效果和过渡动画

#### 4. 本地化存储系统
- **数据持久化**: localStorage实现
- **用户隔离**: 基于用户名的数据分离
- **版本管理**: 存档版本兼容处理

#### 5. 关卡管理系统
- **配置驱动**: JSON配置文件定义关卡
- **动态加载**: 按需加载关卡资源
- **进度保存**: 关卡解锁状态保存

#### 6. 成就系统
- **事件驱动**: 基于游戏事件的成就检测
- **提示系统**: Toast通知成就解锁
- **数据持久化**: 成就状态本地保存

### 技术架构特点

#### 1. 模块化设计优势
- **低耦合**: 各管理器独立运行，减少相互依赖
- **高内聚**: 相关功能集中在同一管理器中
- **易维护**: 功能修改只需关注对应管理器
- **易扩展**: 新功能通过添加新管理器实现

#### 2. 性能优化策略
- **资源预加载**: 关键资源在游戏启动时预加载
- **对象池**: 频繁创建销毁的对象使用对象池
- **事件节流**: 防止高频事件导致的性能问题
- **Canvas优化**: 使用离屏Canvas进行复杂绘制

#### 3. 用户体验设计
- **响应式界面**: 适配不同屏幕尺寸
- **音效反馈**: 丰富的音效和音乐系统
- **视觉反馈**: 动画和特效增强沉浸感
- **进度保存**: 游戏进度自动保存

#### 4. 代码质量保证
- **错误处理**: 完善的异常捕获和处理
- **日志系统**: 详细的调试信息输出
- **代码注释**: 关键逻辑都有详细注释
- **测试支持**: 提供测试页面和工具

### 开发流程和规范

#### 1. 文件命名规范
- **管理器**: 使用`Manager`后缀 (如`SoundManager`)
- **游戏对象**: 使用PascalCase (如`Boss`, `Enemy`)
- **工具类**: 使用`Util`后缀 (如`Util.js`)
- **配置文件**: 使用kebab-case (如`game-style.css`)

#### 2. 代码组织原则
- **单一职责**: 每个类/管理器只负责一个功能领域
- **开闭原则**: 对扩展开放，对修改封闭
- **依赖注入**: 通过构造函数注入依赖
- **接口隔离**: 提供最小化的公共接口

#### 3. 资源管理规范
- **路径规范**: 使用相对路径，便于部署
- **命名规范**: 资源文件使用描述性名称
- **分类管理**: 按类型分目录存放资源
- **版本控制**: 重要资源进行版本管理

### 部署和发布

#### 1. 文件结构优化
- **压缩优化**: 生产环境使用压缩版本
- **缓存策略**: 设置合适的缓存头
- **CDN部署**: 静态资源使用CDN加速

#### 2. 兼容性考虑
- **浏览器兼容**: 支持主流浏览器
- **设备适配**: 支持桌面和移动设备
- **性能优化**: 针对不同设备优化性能

#### 3. 维护和更新
- **版本管理**: 使用语义化版本号
- **更新机制**: 支持增量更新
- **回滚策略**: 支持版本回滚
- **监控系统**: 实时监控游戏状态

这个架构文档现在准确反映了当前游戏项目的实际结构和技术实现，为项目的维护、扩展和优化提供了清晰的指导。